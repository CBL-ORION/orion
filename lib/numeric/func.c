#include <math.h>

#include "numeric/func.h"
#include "util/util.h"

/* Compute
 *
 *     n!
 *
 * that is, the factorial of the input argument `n`.
 *
 * The bounds of this function on a 64-bit machine are n âˆˆ [ 0, 170 ].
 */
float64 factorial_int64_t(uint8_t n) {
	/* maximum for a float64 such that
	 *     fact(MAX_FACTORIAL_N_FLOAT64) <= FLT_MAX
	 * and
	 *     isinf( fact(MAX_FACTORIAL_N_FLOAT64 + 1 ) ) == 1 # positive infinity
	 * */
	const unsigned int MAX_FACTORIAL_N_FLOAT64 = 170;
	/* this table is static because it is stored for all function calls */
	double factorial_lut[] = {
		/*   0! */ 1L,
		/*   1! */ 1L,
		/*   2! */ 2L,
		/*   3! */ 6L,
		/*   4! */ 24L,
		/*   5! */ 120L,
		/*   6! */ 720L,
		/*   7! */ 5040L,
		/*   8! */ 40320L,
		/*   9! */ 362880.0L,
		/*  10! */ 3628800.0L,
		/*  11! */ 39916800.0L,
		/*  12! */ 479001600.0L,
		/*  13! */ 6227020800.0L,
		/*  14! */ 87178291200.0L,
		/*  15! */ 1307674368000.0L,
		/*  16! */ 20922789888000.0L,
		/*  17! */ 355687428096000.0L,
		/*  18! */ 6402373705728000.0L,
		/*  19! */ 121645100408832000.0L,
		/*  20! */ 0.243290200817664e19L,
		/*  21! */ 0.5109094217170944e20L,
		/*  22! */ 0.112400072777760768e22L,
		/*  23! */ 0.2585201673888497664e23L,
		/*  24! */ 0.62044840173323943936e24L,
		/*  25! */ 0.15511210043330985984e26L,
		/*  26! */ 0.403291461126605635584e27L,
		/*  27! */ 0.10888869450418352160768e29L,
		/*  28! */ 0.304888344611713860501504e30L,
		/*  29! */ 0.8841761993739701954543616e31L,
		/*  30! */ 0.26525285981219105863630848e33L,
		/*  31! */ 0.822283865417792281772556288e34L,
		/*  32! */ 0.26313083693369353016721801216e36L,
		/*  33! */ 0.868331761881188649551819440128e37L,
		/*  34! */ 0.29523279903960414084761860964352e39L,
		/*  35! */ 0.103331479663861449296666513375232e41L,
		/*  36! */ 0.3719933267899012174679994481508352e42L,
		/*  37! */ 0.137637530912263450463159795815809024e44L,
		/*  38! */ 0.5230226174666011117600072241000742912e45L,
		/*  39! */ 0.203978820811974433586402817399028973568e47L,
		/*  40! */ 0.815915283247897734345611269596115894272e48L,
		/*  41! */ 0.3345252661316380710817006205344075166515e50L,
		/*  42! */ 0.1405006117752879898543142606244511569936e52L,
		/*  43! */ 0.6041526306337383563735513206851399750726e53L,
		/*  44! */ 0.265827157478844876804362581101461589032e55L,
		/*  45! */ 0.1196222208654801945619631614956577150644e57L,
		/*  46! */ 0.5502622159812088949850305428800254892962e58L,
		/*  47! */ 0.2586232415111681806429643551536119799692e60L,
		/*  48! */ 0.1241391559253607267086228904737337503852e62L,
		/*  49! */ 0.6082818640342675608722521633212953768876e63L,
		/*  50! */ 0.3041409320171337804361260816606476884438e65L,
		/*  51! */ 0.1551118753287382280224243016469303211063e67L,
		/*  52! */ 0.8065817517094387857166063685640376697529e68L,
		/*  53! */ 0.427488328406002556429801375338939964969e70L,
		/*  54! */ 0.2308436973392413804720927426830275810833e72L,
		/*  55! */ 0.1269640335365827592596510084756651695958e74L,
		/*  56! */ 0.7109985878048634518540456474637249497365e75L,
		/*  57! */ 0.4052691950487721675568060190543232213498e77L,
		/*  58! */ 0.2350561331282878571829474910515074683829e79L,
		/*  59! */ 0.1386831185456898357379390197203894063459e81L,
		/*  60! */ 0.8320987112741390144276341183223364380754e82L,
		/*  61! */ 0.507580213877224798800856812176625227226e84L,
		/*  62! */ 0.3146997326038793752565312235495076408801e86L,
		/*  63! */ 0.1982608315404440064116146708361898137545e88L,
		/*  64! */ 0.1268869321858841641034333893351614808029e90L,
		/*  65! */ 0.8247650592082470666723170306785496252186e91L,
		/*  66! */ 0.5443449390774430640037292402478427526443e93L,
		/*  67! */ 0.3647111091818868528824985909660546442717e95L,
		/*  68! */ 0.2480035542436830599600990418569171581047e97L,
		/*  69! */ 0.1711224524281413113724683388812728390923e99L,
		/*  70! */ 0.1197857166996989179607278372168909873646e101L,
		/*  71! */ 0.8504785885678623175211676442399260102886e102L,
		/*  72! */ 0.6123445837688608686152407038527467274078e104L,
		/*  73! */ 0.4470115461512684340891257138125051110077e106L,
		/*  74! */ 0.3307885441519386412259530282212537821457e108L,
		/*  75! */ 0.2480914081139539809194647711659403366093e110L,
		/*  76! */ 0.188549470166605025498793226086114655823e112L,
		/*  77! */ 0.1451830920282858696340707840863082849837e114L,
		/*  78! */ 0.1132428117820629783145752115873204622873e116L,
		/*  79! */ 0.8946182130782975286851441715398316520698e117L,
		/*  80! */ 0.7156945704626380229481153372318653216558e119L,
		/*  81! */ 0.5797126020747367985879734231578109105412e121L,
		/*  82! */ 0.4753643337012841748421382069894049466438e123L,
		/*  83! */ 0.3945523969720658651189747118012061057144e125L,
		/*  84! */ 0.3314240134565353266999387579130131288001e127L,
		/*  85! */ 0.2817104114380550276949479442260611594801e129L,
		/*  86! */ 0.2422709538367273238176552320344125971528e131L,
		/*  87! */ 0.210775729837952771721360051869938959523e133L,
		/*  88! */ 0.1854826422573984391147968456455462843802e135L,
		/*  89! */ 0.1650795516090846108121691926245361930984e137L,
		/*  90! */ 0.1485715964481761497309522733620825737886e139L,
		/*  91! */ 0.1352001527678402962551665687594951421476e141L,
		/*  92! */ 0.1243841405464130725547532432587355307758e143L,
		/*  93! */ 0.1156772507081641574759205162306240436215e145L,
		/*  94! */ 0.1087366156656743080273652852567866010042e147L,
		/*  95! */ 0.103299784882390592625997020993947270954e149L,
		/*  96! */ 0.9916779348709496892095714015418938011582e150L,
		/*  97! */ 0.9619275968248211985332842594956369871234e152L,
		/*  98! */ 0.942689044888324774562618574305724247381e154L,
		/*  99! */ 0.9332621544394415268169923885626670049072e156L,
		/* 100! */ 0.9332621544394415268169923885626670049072e158L,
		/* 101! */ 0.9425947759838359420851623124482936749562e160L,
		/* 102! */ 0.9614466715035126609268655586972595484554e162L,
		/* 103! */ 0.990290071648618040754671525458177334909e164L,
		/* 104! */ 0.1029901674514562762384858386476504428305e167L,
		/* 105! */ 0.1081396758240290900504101305800329649721e169L,
		/* 106! */ 0.1146280563734708354534347384148349428704e171L,
		/* 107! */ 0.1226520203196137939351751701038733888713e173L,
		/* 108! */ 0.132464181945182897449989183712183259981e175L,
		/* 109! */ 0.1443859583202493582204882102462797533793e177L,
		/* 110! */ 0.1588245541522742940425370312709077287172e179L,
		/* 111! */ 0.1762952551090244663872161047107075788761e181L,
		/* 112! */ 0.1974506857221074023536820372759924883413e183L,
		/* 113! */ 0.2231192748659813646596607021218715118256e185L,
		/* 114! */ 0.2543559733472187557120132004189335234812e187L,
		/* 115! */ 0.2925093693493015690688151804817735520034e189L,
		/* 116! */ 0.339310868445189820119825609358857320324e191L,
		/* 117! */ 0.396993716080872089540195962949863064779e193L,
		/* 118! */ 0.4684525849754290656574312362808384164393e195L,
		/* 119! */ 0.5574585761207605881323431711741977155627e197L,
		/* 120! */ 0.6689502913449127057588118054090372586753e199L,
		/* 121! */ 0.8094298525273443739681622845449350829971e201L,
		/* 122! */ 0.9875044200833601362411579871448208012564e203L,
		/* 123! */ 0.1214630436702532967576624324188129585545e206L,
		/* 124! */ 0.1506141741511140879795014161993280686076e208L,
		/* 125! */ 0.1882677176888926099743767702491600857595e210L,
		/* 126! */ 0.237217324288004688567714730513941708057e212L,
		/* 127! */ 0.3012660018457659544809977077527059692324e214L,
		/* 128! */ 0.3856204823625804217356770659234636406175e216L,
		/* 129! */ 0.4974504222477287440390234150412680963966e218L,
		/* 130! */ 0.6466855489220473672507304395536485253155e220L,
		/* 131! */ 0.8471580690878820510984568758152795681634e222L,
		/* 132! */ 0.1118248651196004307449963076076169029976e225L,
		/* 133! */ 0.1487270706090685728908450891181304809868e227L,
		/* 134! */ 0.1992942746161518876737324194182948445223e229L,
		/* 135! */ 0.269047270731805048359538766214698040105e231L,
		/* 136! */ 0.3659042881952548657689727220519893345429e233L,
		/* 137! */ 0.5012888748274991661034926292112253883237e235L,
		/* 138! */ 0.6917786472619488492228198283114910358867e237L,
		/* 139! */ 0.9615723196941089004197195613529725398826e239L,
		/* 140! */ 0.1346201247571752460587607385894161555836e242L,
		/* 141! */ 0.1898143759076170969428526414110767793728e244L,
		/* 142! */ 0.2695364137888162776588507508037290267094e246L,
		/* 143! */ 0.3854370717180072770521565736493325081944e248L,
		/* 144! */ 0.5550293832739304789551054660550388118e250L,
		/* 145! */ 0.80479260574719919448490292577980627711e252L,
		/* 146! */ 0.1174997204390910823947958271638517164581e255L,
		/* 147! */ 0.1727245890454638911203498659308620231933e257L,
		/* 148! */ 0.2556323917872865588581178015776757943262e259L,
		/* 149! */ 0.380892263763056972698595524350736933546e261L,
		/* 150! */ 0.571338395644585459047893286526105400319e263L,
		/* 151! */ 0.8627209774233240431623188626544191544816e265L,
		/* 152! */ 0.1311335885683452545606724671234717114812e268L,
		/* 153! */ 0.2006343905095682394778288746989117185662e270L,
		/* 154! */ 0.308976961384735088795856467036324046592e272L,
		/* 155! */ 0.4789142901463393876335775239063022722176e274L,
		/* 156! */ 0.7471062926282894447083809372938315446595e276L,
		/* 157! */ 0.1172956879426414428192158071551315525115e279L,
		/* 158! */ 0.1853271869493734796543609753051078529682e281L,
		/* 159! */ 0.2946702272495038326504339507351214862195e283L,
		/* 160! */ 0.4714723635992061322406943211761943779512e285L,
		/* 161! */ 0.7590705053947218729075178570936729485014e287L,
		/* 162! */ 0.1229694218739449434110178928491750176572e290L,
		/* 163! */ 0.2004401576545302577599591653441552787813e292L,
		/* 164! */ 0.3287218585534296227263330311644146572013e294L,
		/* 165! */ 0.5423910666131588774984495014212841843822e296L,
		/* 166! */ 0.9003691705778437366474261723593317460744e298L,
		/* 167! */ 0.1503616514864999040201201707840084015944e301L,
		/* 168! */ 0.2526075744973198387538018869171341146786e303L,
		/* 169! */ 0.4269068009004705274939251888899566538069e305L,
		/* 170! */ 0.7257415615307998967396728211129263114717e307L,
	};

	if( n > MAX_FACTORIAL_N_FLOAT64 ) {
		die("factorial of %d can not be represented using float64. Maximum is %d", n, MAX_FACTORIAL_N_FLOAT64);
	}

	return factorial_lut[n];
}

/* Horner's method for polynomial evaluation.
 *
 * This function evaluates a polynomial of degree n
 *
 *   f(x) =    c_{0}
 *          +  c_{1}   * x^{1}
 *          +  c_{2}   * x^{2}
 *          + ...
 *          +  c_{n-1} * x^{n-1},
 *          +  c_{n}   * x^{n},
 *
 * at given the value x.
 *
 * Input:
 *
 *    - coefficients:
 *          The cofficients of the polynomial f(x). These cofficients are
 *          passed in an array of length (polynomial_degree + 1) and are in the
 *          following order:
 *
 *              { c_0, c_1, c_2, ..., c_{n} }
 *
 *          which has (n+1) elements.
 *
 *          Thus, for any f(x), f(0) = c_0.
 *
 *    - polynomial_degree:
 *          The degree of the polynomial (i.e., n in the above definition of
 *          f(x))
 *
 *    - x:
 *          The point at which to evaluate the polynomial f(x).
 *
 * See <https://en.wikipedia.org/wiki/Horner's_method>.
 */
float64 polyeval_horners_float64(const float64* coefficients, size_t polynomial_degree, float64 x ) {
	float64 poly_accum = 0.0;
	for(int i = polynomial_degree; i >= 0; i--) {
		poly_accum = poly_accum * x + coefficients[i];
	}
	return poly_accum;
}
